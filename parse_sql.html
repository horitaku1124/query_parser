<!DOCTYPE html>
<html>
<head>
<script src="js/query_parser.js"></script>
<script src="js/query_node.js"></script>
<meta charset="UTF-8">
<title>SQL</title>
<script type="text/javascript">
    var ad_repetitions = [
        {
            id: 1,
            name: "taro",
            age: 26,
            division: 100,
            is_expired: 0
        },
        {
            id: 2,
            name: "kotaro",
            age: 31,
            division: 100,
            is_expired: 1
        },
        {
            id: 3,
            name: "santaro",
            age: 19,
            division: 200,
            is_expired: 0
        },
        {
            id: 4,
            name: "shiro",
            age: 20,
            division: 200,
            is_expired: 0
        }
    ];
    var division_table = [
        {div_id: 100, div_name: "Development"},
        {div_id: 200, div_name: "Operation"},
    ];
    function convert() {
        var sql = document.getElementById('sql').value;
        var parser = new QueryParser(window);
        try {

            var parseResult = parser.convert(sql);
            if(parseResult.type == "select" && parseResult.dataSource.length > 0) {
                var dataSource = parseResult.dataSource;
                var names = Object.keys(dataSource[0]);

                var table = "<table>";
                table += "<tr>";
                for(let name of names) {
                    table += "<th>" + name + "</th>";
                }
                table += "</tr>";

                for(let i = 0;i < dataSource.length;i++) {
                    table += "<tr>";
                    for(let name of names) {
                        table += "<td>" + dataSource[i][name] + "</td>";
                    }
                    table += "</tr>";
                }

                table += "</table>";
                document.getElementById('result').innerHTML = table;
            }
            if(parseResult.type == "insert") {
                var csvData = "";
                var names = parseResult.selectors, nameLength = names.length;

                var table = "<table>";
                table += "<tr>";
                for(let name of names) {
                    table += "<th>" + name + "</th>";
                }
                table += "</tr>";
                csvData = names.join(",") + "\r\n";

                table += "<tr>";
                for(let j = 0;j < nameLength;j++) {
                    table += "<td>" + parseResult.values[j] + "</td>";
                }
                csvData += parseResult.values.join(",") + "\r\n";
                table += "</tr>";

                table += "</table>";
                document.getElementById('result').innerHTML = table;

                const blob1 = new Blob([csvData], { type: "text/csv" });
                var url = window.URL ? window.URL.createObjectURL(blob1) : window.webkitURL.createObjectURL(blob1);

                console.log(blob1, url);
                var download_link = document.getElementById('download_link');
                download_link.setAttribute("href", url);
                download_link.setAttribute("download", parseResult["into"] + ".csv");
            }
            console.log(parseResult);
        } catch (e) {
            document.getElementById('result').innerHTML = e.message;
            console.log(e);
        }
    }
    window.onload = function() {
        convert();
    }
</script>
    <style>
        #result table {
            border-collapse: collapse;
        }
        #result table tr th{
            background-color: #e9f1ff;
        }
        #result table tr th, #result table tr td{
            border: 1px solid #aeaeae;
            padding: 3px;
        }
    </style>
</head>
<body>
<input type="button" value="Convert" onclick="convert();" />
<div>
<!-- <textarea id="sql" style="width: 500px;height:300px;">SELECT id,name,div_id,div_name FROM `ad_repetitions` INNER JOIN `division_table` ON division = div_id  WHERE division = 100 AND age > 20 AND is_expired &lt;&gt; 1</textarea> -->
<textarea id="sql" style="width: 500px;height:300px;">INSERT INTO ad_repetitions(id , name, age) VALUES (105,'Goro', 25)</textarea>
</div>

<div id="result"></div>
<div><a id="download_link"  href="">CSVでダウンロード</a></div>
</body>
</html>